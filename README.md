# iOS Build in Shared Infrastructure with tart.run and Cirrus CLI

In this post, IтАЩll share an idea on how to set up a scalable and efficient iOS build system using `tart.run` and `cirrus-cli`, enabling shared macOS infrastructure for CI workflows, all within an on-premises data center.

Not a deep dive, just something that worked for me and might help others looking for similar solutions.

---

**ржЖржкржирж╛рж░ iOS ржбрзЗржнрзЗрж▓ржкржорзЗржирзНржЯ ржЯрж┐ржорзЗрж░ ржорж╛рж▓рзНржЯрж┐ржкрж▓ ржЕрзНржпрж╛ржкрзЗрж░ ржЬржирзНржп ржорзЛржЯрж╛ржорзЛржЯрж┐ ржкрзНрж░рждрж┐ржжрж┐ржи ржЫрзЛржЯржЦрж╛ржЯрзЛ ржХржпрж╝рзЗржХржЯрж╛ ржХрж░рзЗ Feature Build ржжрж┐рждрзЗ рж╣ржпрж╝ред**  
ржзрж░рзЗ ржирж┐рж▓рж╛ржо, ржЖржкржирж╛рж░ ржбрзЗржЯрж╛ рж╕рзЗржирзНржЯрж╛рж░рзЗ ржПржХржЯрж╛ Mac Mini ржЖржЫрзЗ ржпрзЗржЦрж╛ржирзЗ рж╣ржпрж╝рждрзЛ ржХрзЛржи ржПржХржЯрж╛ opensource CI/CD ржЯрзНржпрзБрж▓ (рж╣рждрзЗ ржкрж╛рж░рзЗ Jenkins, ржмрж╛ GitLab CI) ржжрж┐ржпрж╝рзЗ ржЕржЯрзЛржорзЗржЯрзЗржб ржмрж┐рж▓рзНржб ржЯрзНрж░рж┐ржЧрж╛рж░ рж╣ржпрж╝ред ржЖржмрж╛рж░ Release Build ржУ ржарж┐ржХ ржПржХржЗ ржкржжрзНржзрждрж┐рждрзЗ рж╣ржпрж╝ред

ржорж╛рж▓рзНржЯрж┐ржкрж▓ ржЕрзНржпрж╛ржк рж╣ржУржпрж╝рж╛рж░ ржХрж╛рж░ржгрзЗ ржПржХржЯрж╛рж░ рж╕рж╛ржерзЗ ржЖрж░рзЗржХржЯрж╛ ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ dependency ржмрж╛ tool ржпрзЗржоржи XCode version, Ruby version, Keychain ржПржмржВ ржПрж░ Signing Management ржЗрждрзНржпрж╛ржжрж┐ ржЗрждрзНржпрж╛ржжрж┐рждрзЗ ржХрж┐ржЫрзБ ржнрж┐ржирзНржирждрж╛ рж░ржпрж╝рзЗржЫрзЗ ржПржмржВ ржПржЗ Shared ржбрж┐ржкрзЗржиржбрзЗржирзНрж╕рж┐ ржорзЗржирзЗржЬ ржХрж░рж╛ DevOps ржЯрж┐ржорзЗрж░ ржЬржирзНржп ржЦрзБржм ржбрж┐ржлрж┐ржХрж╛рж▓рзНржЯ рж╣ржпрж╝рзЗ ржпрж╛ржпрж╝ ржПржмржВ ржПржХ ржкрж░рзНржпрж╛ржпрж╝рзЗ ржЖрж░ ржорзЗржирзЗржЬ ржХрж░рж╛ рж╕ржорзНржнржм рж╣ржпрж╝рзЗ ржирж╛ржУ ржЙржарждрзЗ ржкрж╛рж░рзЗред ржорзБрж▓ржд: ржП ржзрж░ржгрзЗрж░ рж╕рж┐ржЯрж┐ржЪржЙржпрж╝рзЗрж╢ржи ржЕржирзЗржХрзЗржЗ ржлрзЗржЗрж╕ ржХрж░рзЗ ржерж╛ржХрзЗржиред

рждрж╛рж░ржкрж░ ржЖржкржирж┐ рж╣ржпрж╝рждрзЛ UTM ржмрж╛ VirtualBox ржПржЗрж╕ржмрзЗрж░ ржХржерж╛ ржЪрж┐ржирзНрждрж╛ ржХрж░ржмрзЗржи, ржХрж┐ржирзНрждрзБ рж╕ржорж╕рзНржпрж╛ рж╣рж▓рзЛтАФ

1. ржПржЗ ржЯрзБрж▓ржЧрзБрж▓рзЛ рждржд ржкрзНрж░рзЛржЧрзНрж░рж╛ржорж┐ржВ ржлрзНрж░рзЗржирзНржбрж▓рж┐ ржирж╛, ржорж╛ржирзЗ ржЖржкржирж┐ ржЦрзБржм рж╕рж╣ржЬрзЗржЗ ржПржЧрзБрж▓рзЛ ржкрзНрж░рзЛржЧрзНрж░рж╛ржорж┐ржВ ржХрзЛржбрзЗрж░ ржорж╛ржзрзНржпржорзЗ ржорзЗржирзЗржЬ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи ржирж╛ред рждржмрзЗ ржЕрж╕ржорзНржнржм ржиржпрж╝ред
2. ржЖржкржирж╛рж░ ржкрзНрж░рждрзНржпрзЗржХржЯрж╛ ржЖрж▓рж╛ржжрж╛ App ржПрж░ ржЬржирзНржп ржЖрж▓рж╛ржжрж╛ ржПржХржЯрж╛ VM рж╕ржм рж╕ржоржпрж╝ ржЪрж╛рж▓рж┐ржпрж╝рзЗ рж░рж╛ржЦрждрзЗ рж╣ржмрзЗ ржпрзЗржЯрж╛ рж╕ржмрж╕ржоржпрж╝ ржПржХржЯрж╛ ржирж┐рж░рзНржжрж┐рж╖рзНржЯ ржкрж░рж┐ржорж╛ржг рж░рж┐рж╕рзЛрж░рзНрж╕ ржмрзНрж▓ржХ ржХрж░рзЗ рж░рж╛ржЦржмрзЗред рж╣ржпрж╝рждрзЛ рзиржЯрж╛рж░ ржмрзЗрж╢рж┐ VM ржЖржкржирж┐ ржР Mac Mini рждрзЗ рж╕ржм рж╕ржоржпрж╝ ржЪрж╛рж▓рж┐ржпрж╝рзЗ рж░рж╛ржЦрждрзЗ ржкрж╛рж░ржмрзЗржи ржирж╛, ржорж╛ржирзЗ рж╕рж░рзНржмрзЛржЪрзНржЪ рж╣ржпрж╝рждрзЛ рзиржЯрж╛ App ржПрж░ ржмрж┐рж▓рзНржб ржПржиржнрж╛ржЗрж░ржиржорзЗржирзНржЯ рж╕рзЗржЯржЖржк ржХрж░рзЗ рж░рж╛ржЦрждрзЗ ржкрж╛рж░ржмрзЗржиред рждрж╛рж░ржкрж░ ржЖржмрж╛рж░ ржУржжрзЗрж░ржХрзЗ Jenkins Worker Node рж╣рж┐рж╕рзЗржмрзЗ рж╕рзЗржЯржЖржк ржХрж░рждрзЗ рж╣ржмрзЗред ржорж╛ржирзЗ ржЕржирзЗржХ ржЭржХрзНржХрж┐ ржЭрж╛ржорзЗрж▓рж╛рж░ ржкрж░ржУ ржЖржкржирж┐ рзиржЯрж╛ App ржПрж░ Build ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯ рж╣ржпрж╝рждрзЛ рж░рзЗржбрж┐ ржХрж░рзЗ рж░рж╛ржЦрждрзЗ ржкрж╛рж░ржмрзЗржиред рждрж╛рж░ ржоржзрзНржпрзЗ ржХрж┐ржЫрзБ рж░рж┐рж╕рзЛрж░рзНрж╕ ржПржЗ ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓рж╛ржЗржЬрзЗрж╢ржирзЗрж░ ржЬржирзНржп ржирж╖рзНржЯржУ рж╣ржЪрзНржЫрзЗред

**ржорж╛ржирзЗ ржорзЛржЯрж╛ржжрж╛ржЧрзЗ ржмрж▓рждрзЗ ржЧрзЗрж▓рзЗ ржПржЗ ржЧрждрж╛ржирзБржЧрждрж┐ржХ ржкржжрзНржзрждрж┐ рж╣ржпрж╝рждрзЛ ржЖржкржирж╛ржХрзЗ рж╕рж░рзНржмрзЛржЪрзНржЪ рзиржЯрж╛ ржЖрж▓рж╛ржжрж╛ App ржПрж░ Build Environment ржжрж┐рждрзЗ ржкрж╛рж░ржмрзЗред ржПржЦржи ржПрж░ рж╕ржорж╛ржзрж╛ржи ржХрж┐ рж╣рждрзЗ ржкрж╛рж░рзЗ?**

---

## Introducing `tart.run`

ржПржХржЯрж╛ ржЦрзБржмржЗ Handy Opensource Project `tart.run` ржЖржкржирж╛ржХрзЗ ржПржЗ ржзрж░ржгрзЗрж░ рж╕рж┐ржЪрж┐ржЙржпрж╝рзЗрж╢ржиржХрзЗ ржПржХржжржо рж╕рж╣ржЬ ржХрж░рзЗ ржжрж┐ржмрзЗред

ржЖржкржирж╛рж░ Mac Mini-рждрзЗ `tart.run` ржЗржирзНрж╕ржЯрж▓ ржХрж░ржмрзЗржи ржЖрж░ ржЫрзЛржЯрзНржЯ рзи-рззржЯрж╛ ржХржорж╛ржирзНржб ржжрж┐ржпрж╝рзЗ `tart.run` ржПрж░ repository ржерзЗржХрзЗ ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ macOS ржПрж░ Template Clone ржХрж░рзЗ рж░рж╛ржЦржмрзЗржиред

ржкрж░рзЗ ржкрж╛ржЗржкрж▓рж╛ржЗржи ржерзЗржХрзЗ ржПржХржжржо readymade macOS рж░рж╛ржи ржХрж░ржмрзЗржи рзктАУрзл рж╕рзЗржХрзЗржирзНржбрзЗрж░ ржоржзрзНржпрзЗ, рждрж╛рж░ржкрж░ ржР ржнрж╛рж░рзНржЪрзБржпрж╝рж╛рж▓ ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯрзЗ ржЖржкржирж╛рж░ code build ржХрж░ржмрзЗржи, рждрж╛рж░ржкрж░ рж╢рзЗрж╖ред

ржПржЗржЦрж╛ржирзЗржУ ржХрж┐ржЫрзБ ржЯрзНрж░рж┐ржХ ржПржкрзНрж▓рж╛ржЗ ржХрж░рждрзЗ рж╣ржмрзЗ ржЖржкржирж╛рж░ expected outcome ржкрзЗрждрзЗред ржЖржкржирж╛рж░ ржкржЫржирзНржжрзЗрж░ рж╕рзНржХрзНрж░рж┐ржкрзНржЯрж┐ржВ рж▓рзНржпрж╛ржЩрзНржЧрзБржпрж╝рзЗржЬ (ржпрзЗржоржи `bash script`) ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ ржЦрзБржм рж╕рж╣ржЬрзЗржЗ ржЖржкржирж┐ ржбрж╛ржпрж╝ржирж╛ржорж┐ржХ ржмрж┐рж▓рзНржб ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯржЧрзБрж▓рзЛ ржорзЗржирзЗржЬ ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржиред ржмрж┐рж▓рзНржб рж╢рзЗрж╖, ржЖржкржирж╛рж░ ржР Ephemeral VM ржмржирзНржз ржХрж░рзЗ Delete ржХрж░рзЗ ржжрж┐рж▓рзЗржиред

ржПржЗ approach ржП ржЖржкржирж┐ ржХрж┐ржирзНрждрзБ рж╕рзЗржЗржо specification ржПрж░ Mac Mini ржмрзНржпрж╛ржмрж╣рж╛рж░ ржХрж░рзЗ ржЕржирзЗржХржЧрзБрж▓рзЛ iOS App ржПрж░ Build automate ржХрж░рждрзЗ ржкрж╛рж░ржмрзЗржи ржХрзЛржи ржкрзНрж░ржХрж╛рж░ ржЭрж╛ржорзЗрж▓рж╛ ржЫрж╛ржбрж╝рж╛ржЗред

---

## Cirrus CLI Integration

ржПржЦржи ржЖрж╕рж┐ ржмрзНржпрж╛ржкрж╛рж░ржЯрж╛ржХрзЗ ржЖрж░рзЛ ржмрзЗрж╢рж┐ рж╕рж╣ржЬ ржХрж░рзЗ ржжрж┐рждрзЗред

`tart.run` ржПрж░ рж╕рж╛ржерзЗ `Cirrus CLI` ржПрж░ integration ржЦрзБржмржЗ ржнрж╛рж▓рзЛред ржЖржкржирж╛рж░ ржПржЦржи рж╢рзБржзрзБ ржжрж░ржХрж╛рж░ рж╣ржмрзЗ ржР Mac Mini рждрзЗ `cirrus-cli` ржЯрзНржпрзБрж▓ржЯрж╛ ржЗржирзНрж╕ржЯрж▓ ржХрж░рж╛ред

рждрж╛рж░ржкрж░ ржЙржкрж░рзЗрж░ ржжрзЗржУржпрж╝рж╛ `tart` ржПрж░ ржЬржирзНржп custom ржпрзЗ script ржмрж╛ржирж╛рждрзЗ рж╣рждрзЛ рж╕рзЗржЯрж╛рж░ ржкрзЗрж░рзЗрж╢рж╛ржирж┐ржУ рж╢рзЗрж╖ред ржПржЦржи рж╢рзБржзрзБ ржЖржкржирж╛рж░ ржХрзЛржб ржмрзЗржЗрж╕рзЗ `.cirrus.yml` ржлрж╛ржЗрж▓ ржмрж╛ржирж╛ржмрзЗржи, ржЖрж░ GitHub Actions-ржПрж░ ржоржд runner ржЖрж░ task define ржХрж░рзЗ ржжрж┐ржмрзЗржиред

рждрж╛рж░ржкрж░ `cirrus run` ржПржЗ ржХржорж╛ржирзНржб ржжрж┐ржмрзЗржи, рждрж╛рж░ржкрж░ рж╢рзЗрж╖ред ЁЯШД


ржПрждрзЛ ржХрж┐ржЫрзБрж░ ржоржзрзНржпрзЗ ржЖржкржирж╛рж░ ржкрж░ржмрж░рзНрждрж┐рждрзЗ ржЪрзЗрж▓рзЗржЮрзНржЬ рж╣ржмрзЗ ржмрж┐ржнрж┐ржирзНржи ржжрж░ржХрж╛рж░рж┐ credentials ржПржмржВ environment variable ржР VM ржП pass ржХрж░рж╛ред

ржПржЯрж╛ржУ ржЖржкржирж┐ ржЦрзБржм рж╕рж╣ржЬрзЗ ржПржХржЯрж╛ `.env.template` ржлрж╛ржЗрж▓ ржжрж┐ржпрж╝рзЗ generate ржХрж░рзЗ ржирж┐рждрзЗ ржкрж╛рж░ржмрзЗржиред ржпрзЗржоржи:

```bash
cirrus run --env-file=.env
```

---

**ржХрзЛржб ржмрзЗржЗрж╕рзЗрж░ basic tree ржПрж░ ржПржХржЯрж╛ ржЙржжрж╛рж╣рж░ржг ржжрж┐рж▓рж╛ржо ржмрзБржЭрж╛рж░ рж╕рзБржмрж┐ржзрж╛рж░рзНржерзЗ (Generated by ChatGPT):**

## Basic iOS App Project Structure

```
MyiOSApp/
тФЬтФАтФА .cirrus.yml
тФЬтФАтФА .env.template
тФЬтФАтФА fastlane/
тФВ   тФФтФАтФА Fastfile
тФЬтФАтФА MyiOSApp/
тФВ   тФЬтФАтФА AppDelegate.swift
тФВ   тФЬтФАтФА SceneDelegate.swift
тФВ   тФЬтФАтФА ViewController.swift
тФВ   тФФтФАтФА Assets.xcassets/
тФЬтФАтФА MyiOSApp.xcodeproj/
тФЬтФАтФА Info.plist
тФФтФАтФА README.md
```

## 1. Clone Tart macOS VM from Cirrus Labs

```bash
# Clone the official macOS Sonoma base VM from Cirrus
tart clone ghcr.io/cirruslabs/macos-sonoma-base:latest macos-sonoma
```

This creates a local Tart VM called `macos-sonoma`.

## 2. Example `.env.template`

This file defines the expected environment variables your app or CI process needs. You or your team can copy this to `.env` and fill in real values.

```bash
# iOS App Configuration Template

# Bundle Identifier of the app
BUNDLE_ID=com.example.myiosapp

# Base URL for API (e.g., staging or production)
API_BASE_URL=https://api.example.com

# Firebase setup
FIREBASE_API_KEY=your_firebase_api_key
FIREBASE_PROJECT_ID=your_firebase_project_id
FIREBASE_APP_ID=your_firebase_app_id

# Fastlane Match or code signing
MATCH_PASSWORD=your_match_password

# App Store Connect API info
APP_STORE_CONNECT_KEY_ID=your_key_id
APP_STORE_CONNECT_ISSUER_ID=your_issuer_id
APP_STORE_CONNECT_API_KEY_PATH=./AuthKey_ABC123.p8
```

## 3. Example `.cirrus.yml`

```yaml
task:
  name: iOS App Build
  macos_instance:
    tart:
      name: macos-sonoma  # Your Tart VM name
  env:
    BUNDLE_ID: $BUNDLE_ID
    API_BASE_URL: $API_BASE_URL
  install_script:
    - gem install bundler
    - bundle install
  script:
    - bundle exec fastlane mylane
```

## 4. Running the Cirrus Task

From the root of your project:

```bash
cirrus run --env-file=.env
```

This runs the task defined in `.cirrus.yml`, injecting environment variables from `.env`.

## Done!
You now have a clean, fast, and scriptable way to build iOS apps inside ephemeral macOS VMs using `tart.run` + `cirrus-cli`.

Happy building!


## Helpful links
- https://tart.run/
- https://tart.run/integrations/cirrus-cli/
